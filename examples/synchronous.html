<script src="libmad.js"></script>
<script>
  var file;
  var chans = 2;

  var AudioContext = window.AudioContext || window.webkitAudioContext;

  AudioContext.prototype.createMadSource = function (chans) {
    var mad;
    var audioContext = this;
    var format;
  
    var createDecoder = function() {
      createMadDecoder(file, function (dec) {
        mad = dec;
      });
    };
  
    var concat = function(a, b) {
      if (typeof b === "undefined") {
        return a;
      }
      var ret = new Float32Array(a.length+b.length);
      ret.set(a);
      ret.subarray(a.length).set(b);
      return ret;
    };
  
    var buflen = 1024;
    var decoded = new Array(chans);
    var chan;
    for (chan = 0; chan < chans; chan++) {
      decoded[chan] = new Float32Array;
    }
  
    var fillBuffer = function(buf) {
      var chan;
      for (chan = 0; chan < decoded.length; chan++) {
        buf.getChannelData(chan).set(decoded[chan].subarray(0, buflen));
        decoded[chan] = decoded[chan].subarray(buflen);
      }
    };
  
    var decode = function(buf) {
      if (decoded[0].length >= buflen) {
        return fillBuffer(buf);
      }
      mad.decodeFrame(function (data, err) {
        if (err) {
          return createDecoder();
        };
  
        var chan;
        if (!format) {
          format = mad.getCurrentFormat();
        }
  
        for (chan = 0; chan < decoded.length; chan++) {
          decoded[chan] = concat(decoded[chan], data[chan]);
        }
        decode(buf);
      });
    };
  
    var node = this.createScriptProcessor(buflen, chans, chans);
    var source = this.createOscillator();
    source.connect(node);
  
    node.onaudioprocess = function (e) {
      if (!mad)
        return;
  
      decode(e.outputBuffer);
    };
  
    node.getCurrentFormat = function () {
      return format;
    };

    node.start = function () {
      createDecoder();
    }
  
    return node;
  };

  var audioContext = new AudioContext;
  var source = audioContext.createMadSource(chans);
  source.connect(audioContext.destination);
  
  function init() {
    document.getElementById("play").onclick = function () {
      file = document.getElementById("file").files[0];
      source.start();
    }
  };
  
  window.addEventListener("load", init, false);
</script>
<input type="file" id="file" accept="audio/mpeg"><br>
<button id="play">Play</button>
